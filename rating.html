<!DOCTYPE html>
<html>
    <head>
        <title></title>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
        <script src="js/jquery.min.js"></script>
        <script src="js/async.js"></script>
        
        <script>
            var pinRubrics = [
                {
                    name: 'ЖЕУ',
                    rubrics: [
                        'Жилищно-коммунальные услуги'
                    ],
                    radius: 300,
                    plus: 1,
                    minus: 0.9,
                    inRating: true
                },
                {
                    name: 'Почта',
                    rubrics: [
                        'Почтовые отделения'
                    ],
                    radius: 1000,
                    plus: 1,
                    minus: 0.9,
                    inRating: true
                },
                {
                    name: 'Банки',
                    rubrics: [
                        'Банки'
                    ],
                    radius: 700,
                    plus: 1,
                    minus: 1,
                    inRating: true
                },
                {
                    name: 'Банкоматы',
                    rubrics: [
                        'Банкоматы'
                    ],
                    radius: 500,
                    plus: 1,
                    minus: 1,
                    inRating: true
                },
                {
                    name: 'Парикмахерские',
                    rubrics: [
                        'Парикмахерские'
                    ],
                    radius: 700,
                    plus: 1,
                    minus: 1,
                    inRating: true
                },
                {
                    name: 'Стоянки',
                    rubrics: [
                        'Автостоянки'
                    ],
                    radius: 700,
                    plus: 1.1,
                    minus: 1,
                    inRating: false
                },
                {
                    name: 'Аптеки',
                    rubrics: [
                        'Аптеки'
                    ],
                    radius: 350,
                    plus: 1,
                    minus: 0.9,
                    inRating: true
                },
                {
                    name: 'Больницы',
                    rubrics: [
                        'Поликлиники детские',
                        'Многопрофильные медицинские центры',
                        'Поликлиники взрослые',
                        'Стоматологические поликлиники',
                        'Стоматологические центры'
                    ],
                    radius: 700,
                    plus: 1,
                    minus: 0.9,
                    inRating: true
                },
                {
                    name: 'Бары',
                    rubrics: [
                        'Бары'
                    ],
                    radius: 800,
                    plus: 1.1,
                    minus: 1,
                    inRating: true
                },
                {
                    name: 'Кафе',
                    rubrics: [
                        'Кафе'
                    ],
                    radius: 800,
                    plus: 1.1,
                    minus: 1,
                    inRating: true
                },
                {
                    name: 'Кондитерские',
                    rubrics: [
                        'Кафе-кондитерские / Кофейни'
                    ],
                    radius: 800,
                    plus: 1.1,
                    minus: 1,
                    inRating: true
                },
                {
                    name: 'Кофейни',
                    rubrics: [
                        'Кафе-кондитерские / Кофейни'
                    ],
                    radius: 800,
                    plus: 1.1,
                    minus: 1,
                    inRating: true
                },
                {
                    name: 'Бассейны',
                    rubrics: [
                        'Бассейны'
                    ],
                    radius: 800,
                    plus: 1,
                    minus: 1,
                    inRating: true
                },
                {
                    name: 'Спортшколы',
                    rubrics: [
                        'Спортивные школы'
                    ],
                    radius: 800,
                    plus: 1,
                    minus: 1,
                    inRating: true
                },
                {
                    name: 'Фитнес',
                    rubrics: [
                        'Фитнес-клубы'
                    ],
                    radius: 800,
                    plus: 1,
                    minus: 1,
                    inRating: true
                },
                {
                    name: 'Стадионы',
                    rubrics: [
                        'Стадионы'
                    ],
                    radius: 800,
                    plus: 1,
                    minus: 1,
                    inRating: true
                },
                {
                    name: 'Образование',
                    rubrics: [
                        'Школы'
                    ],
                    radius: 700,
                    plus: 1,
                    minus: 0.9,
                    inRating: true
                },
                {
                    name: 'Детские сады',
                    rubrics: [
                        'Детские сады / Ясли'
                    ],
                    radius: 400,
                    plus: 1,
                    minus: 0.9,
                    inRating: true
                },
                {
                    name: 'Боулинг',
                    rubrics: [
                        'Боулинг'
                    ],
                    radius: 900,
                    plus: 1.1,
                    minus: 1,
                    inRating: true
                },
                {
                    name: 'Кино',
                    rubrics: [
                        'Кинотеатры'
                    ],
                    radius: 900,
                    plus: 1.1,
                    minus: 1,
                    inRating: true
                },
                {
                    name: 'Парки',
                    rubrics: [
                        'Парки культуры и отдыха'                        
                    ],
                    radius: 2000,
                    plus: 1.1,
                    minus: 1,
                    inRating: false
                },
                {
                    name: 'Театры',
                    rubrics: [
                        'Театры'                        
                    ],
                    radius: 2000,
                    plus: 1.1,
                    minus: 1,
                    inRating: false
                },
                {
                    name: 'Гипермаркеты',
                    rubrics: [
                        'Гипермаркеты'                        
                    ],
                    radius: 2000,
                    plus: 1,
                    minus: 1,
                    inRating: false
                },
                {
                    name: 'Продукты',
                    rubrics: [
                        'Продовольственные магазины'                        
                    ],
                    radius: 400,
                    plus: 1,
                    minus: 1,
                    inRating: true
                },
                {
                    name: 'Супермаркеты',
                    rubrics: [
                        'Супермаркеты'                        
                    ],
                    radius: 1000,
                    plus: 1,
                    minus: 1,
                    inRating: true
                },
                {
                    name: 'Торговые центры',
                    rubrics: [
                        'Торговые центры'
                    ],
                    radius: 1000,
                    plus: 1,
                    minus: 1,
                    inRating: true
                }
                
            ];
            
            var api_key = 'rudvjt8277';
            var project = 'Новосибирск';
            var point = '82.8973495299875, 54.9801322040422';
            //http://catalog.api.2gis.ru/searchinrubric?what=хостинг&where=новосибирск&page=1&pagesize=30&sort=relevance&version=1.3&key=1234567890
            
            $(function() {

                var searches = [];
                var results = [];
                $.each(pinRubrics, function(pinIndex, pinValue) {
                    if(!results[pinIndex]) {
                        results[pinIndex] = {
                            total: 0,
                            firms: []
                        };
                    }
                    $.each(pinValue.rubrics, function(index, value) {

                        var searchFunction = function(callback) {
                            var params = {
                                what: value,
                                point: point,
                                radius: pinValue.radius,
                                //where: project,
                                key: api_key,
                                output: 'jsonp',
                                page: 1,
                                pagesize: 50,
                                version: '1.3',
                                sort: 'relevance'                            
                            };
                            //$.getJSON('http://catalog.api.2gis.ru/searchinrubric?callback=?', params, function(data) {
                            $.getJSON('http://catalog.api.2gis.ru/search?callback=?', params, function(data) {
                                
                                console.log(data);
                                results[pinIndex].total += data.response_code == '200' ? parseInt(data.total) : 0;
                                results[pinIndex].firms = data.result;

                                callback();
                            });
                        }
                        searches.push(searchFunction);

                    });
                });

                //async.parallel(searches, function() {
                async.series(searches, function() {
                    console.log(results);
                    var rating = 0;
                    $.each(pinRubrics, function(index, value) {
                        if(results[index].total > 0  && pinRubrics[index].inRating )
                            rating += 3.08;
                    });

                    $.each(pinRubrics, function(index, value) {
                        if(results[index].total == 0 && pinRubrics[index].inRating )
                            rating *= pinRubrics[index].minus;
                    });
                    
                    $.each(pinRubrics, function(index, value) {
                        if(results[index].total > 1 && pinRubrics[index].inRating )
                            rating *= pinRubrics[index].plus;
                    });
                    
                    console.log( '=====================' + rating + '=====================' );
                });

            });
            
        </script>
    </head>
    <body>
        <div></div>
    </body>
</html>
